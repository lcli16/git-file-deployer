<h1 align="center">
<strong>GifFileDeployer</strong>
</h1>

<p align="center"> 
 
  <strong>这是一个用于自动化部署项目的 Bash 脚本，支持 Git 仓库同步、增量更新、备份恢复等功能。主要用于同步线上项目的代码，并自动生成相应的备份和恢复方案。
  </strong>
</p>

<p align="center">
  <a href="#功能特性">功能特性</a> •
  <a href="#使用方法">使用方法</a> •
  <a href="#参数说明">参数说明</a> •
  <a href="#目录结构">目录结构</a> •
  <a href="#部署流程">部署流程</a> •
  <a href="#状态码说明">状态码说明</a> •
  <a href="#注意事项">注意事项</a>
</p>

<br>

## 功能特性

| 功能 | 说明 |
|------|------|
| 🔄 **Git 同步** | 自动从远程 Git 仓库拉取最新代码 |
| 📦 **增量部署** | 仅同步变更的文件，提高部署效率 |
| 📋 **自动备份** | 部署前自动备份将要更改的文件 |
| 🚀 **一键回滚** | 部署失败时自动恢复到上一版本 |
| 📊 **部署统计** | 显示部署过程中的文件变更统计信息 |
| 🎯 **多分支支持** | 可以部署指定的 Git 分支 |
| 🛡️ **参数验证** | 部署前验证所有参数的合法性 |
| 📈 **进度显示** | 直观的进度条显示部署进度 |
| 📝 **详细日志** | 可选的详细模式，显示部署过程中的详细信息 |
| 🚫 **文件过滤** | 支持通过 .deploy-ignore 文件过滤不需要同步的文件 |
| 🔒 **并发控制** | 防止多个部署进程同时运行 |
| ⏱️ **智能部署** | 仅在检测到实际变更时才执行部署操作 |

## 使用方法

### 基本用法

```
# 使用默认配置进行部署
./deploy.sh

# 使用详细模式进行部署（显示详细过程信息）
./deploy.sh -v

# 部署指定分支
./deploy.sh -b develop

# 指定部署工作目录和分支
./deploy.sh -w /path/to/deploy -b feature/new-ui

# 指定目标目录和分支
./deploy.sh -t /path/to/target -b feature/new-ui

# 指定忽略文件路径
./deploy.sh -i /path/to/.deploy-ignore
```
```
=====================================================================================

   ____ _ _        _____ _ _            ____             _
  / ___(_) |_     |  ___(_) | ___      |  _ \  ___ _ __ | | ___  _   _  ___ _ __
 | |  _| | __|____| |_  | | |/ _ \_____| | | |/ _ \ '_ \| |/ _ \| | | |/ _ \ '__|
 | |_| | | ||_____|  _| | | |  __/_____| |_| |  __/ |_) | | (_) | |_| |  __/ |
  \____|_|\__|    |_|   |_|_|\___|     |____/ \___| .__/|_|\___/ \__, |\___|_|
                                                  |_|            |___/
    
=====================================================================================
用法: deploy-v2.sh [选项]

选项:
  -h                  显示此帮助信息
  -v                  详细模式，显示更多部署过程信息
  -t <target_dir>     设置目标部署目录 (默认: /www/wwwroot/test.hctx.cc)
  -r <git_repo>       设置Git仓库地址 (默认: git@codeup.aliyun.com:685f785033ca8867a43522e6/gysx/gysx-server-v2.git)
  -w <deploy_dir>     设置部署工作目录，基于此目录和分支名自动设置缓存、备份等路径
  -c <git_cache>      设置Git缓存目录 (默认: 基于部署工作目录或 /www/wwwroot/deploy/deploy/master/cache)
  -b <git_branch>     设置Git分支 (默认: master)
  -d <backup_dir>     设置备份目录 (默认: 基于部署工作目录或 /www/wwwroot/deploy/deploy/master/backups)
  -n <max_backups>    设置最大备份数量 (默认: 5)
  -s <status_file>    设置状态文件路径 (默认: 基于部署工作目录或 /www/wwwroot/deploy/deploy/master/deploy_status)
  -e <error_file>     设置错误详情文件路径 (默认: 基于部署工作目录或 /www/wwwroot/deploy/deploy/master/error_details)

说明:
  如果未设置部署工作目录(-w)，则默认使用脚本所在目录下的deploy目录（脚本默认路径为/www/wwwroot/gysx-server-deploy）
  基于部署工作目录和分支名自动设置以下路径:
    分支部署目录:    <deploy_dir>/<branch_name>
    Git缓存目录:     <分支部署目录>/cache
    备份目录:        <分支部署目录>/backups
    状态文件:        <分支部署目录>/deploy_status
    错误详情文件:    <分支部署目录>/error_details

示例:
  deploy-v2.sh                  # 使用默认配置进行部署
  deploy-v2.sh -v               # 使用默认配置并开启详细模式进行部署
  deploy-v2.sh -b develop       # 部署develop分支
  deploy-v2.sh -w /path/to/deploy -b feature/new-ui  # 指定工作目录和分支
  deploy-v2.sh -t /path/to/target -b feature/new-ui  # 指定目标目录和分支
  deploy-v2.sh -h               # 显示此帮助信息
```
## 参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `-h` | 显示帮助信息 | - |
| `-v` | 详细模式，显示更多部署过程信息 | 关闭 |
| `-t <target_dir>` | 设置目标部署目录 | `/www/wwwroot/test.hctx.cc` |
| `-r <git_repo>` | 设置Git仓库地址 | `git@codeup.aliyun.com:685f785033ca8867a43522e6/gysx/gysx-server-v2.git` |
| `-w <deploy_dir>` | 设置部署工作目录，基于此目录和分支名自动设置缓存、备份等路径 | 脚本所在目录下的 `deploy` 目录 |
| `-c <git_cache>` | 设置Git缓存目录 | `<分支部署目录>/cache` |
| `-b <git_branch>` | 设置Git分支 | `master` |
| `-d <backup_dir>` | 设置备份目录 | `<分支部署目录>/backups` |
| `-n <max_backups>` | 设置最大备份数量 | `5` |
| `-s <status_file>` | 设置状态文件路径 | `<分支部署目录>/deploy_status` |
| `-e <error_file>` | 设置错误详情文件路径 | `<分支部署目录>/error_details` |
| `-i <ignore_file>` | 设置忽略文件路径 | `<分支部署目录>/.deploy-ignore` |
| `-l <lock_file>` | 设置锁文件路径 | `<分支部署目录>/deploy.lock` |

## 目录结构

当指定部署工作目录时，脚本会自动创建以下目录结构：

```
<deploy_dir>/                   # 部署工作目录
└── <branch_name>/              # 分支部署目录
    ├── cache/                  # Git缓存目录
    ├── backups/                # 备份目录
    ├── deploy_status           # 状态文件
    ├── error_details           # 错误详情文件
    ├── .deploy-ignore          # 默认忽略文件
    └── deploy.lock             # 部署锁文件
```

## 并发控制

为了避免多个部署进程同时运行导致冲突，脚本实现了基于文件锁的并发控制机制：

1. 每次运行时会在分支部署目录下创建一个 `deploy.lock` 文件
2. 该文件包含当前运行进程的 PID
3. 如果检测到锁文件且对应进程仍在运行，则拒绝启动新实例
4. 脚本正常退出或异常终止时会自动清理锁文件

## 智能部署

脚本具有智能判断能力，只在真正有文件变更时才会执行部署操作：

1. 检查 Git 提交历史确定是否有新变更
2. 应用忽略规则过滤不需要部署的文件
3. 如果最终没有需要变更的文件，则直接退出并提示 "无新变更"

## 忽略文件 (.deploy-ignore) 说明

部署脚本支持通过 `.deploy-ignore` 文件过滤不需要同步的文件和目录。该文件遵循以下规则：

1. 每一行代表一个过滤规则
2. 空行和以 `#` 开头的行会被忽略
3. 支持以下几种模式：
   - 完全匹配：`/path/to/file.txt`
   - 目录匹配：以 `/` 结尾的表示目录，会忽略该目录下所有文件，如 `vendor/`
   - 通配符模式：支持常见的 shell 通配符，如 `*.zip`、`*.log`
4. 匹配是基于相对于项目根目录的路径

示例 `.deploy-ignore` 文件：

```
# 注释行会被忽略
/vendor/     # 忽略 vendor 目录及其所有内容
.env         # 忽略 .env 文件
*.zip        # 忽略所有 zip 文件
*.log        # 忽略所有日志文件
.DS_Store    # 忽略 macOS 的 .DS_Store 文件
```

## 部署流程

1. **参数验证**: 验证所有输入参数的合法性
2. **初始化缓存**: 如果缓存目录不存在，则克隆远程仓库
3. **更新代码**: 从远程仓库拉取最新代码
4. **比较差异**: 比较当前版本与上次部署版本的文件差异
5. **创建备份**: 对将要更改的文件创建备份
6. **同步文件**: 将变更的文件同步到目标目录
7. **清理文件**: 删除已移除的文件
8. **更新版本**: 记录当前部署的版本号
9. **清理旧备份**: 保留指定数量的备份，删除旧备份

## 状态码说明

| 状态码 | 说明 |
|--------|------|
| 0 | 部署成功 |
| 1 | 部署失败 |
| 10 | 无变更 |

## 注意事项

1. 脚本会在部署前自动创建所需的目录结构
2. 部署过程中出现错误会自动回滚到上一版本
3. 默认保留最近5个备份，可通过 `-n` 参数调整
4. 脚本使用 `set -euo pipefail` 选项，遇到错误会立即退出
5. 部署过程中会自动处理中文文件名的编码问题