<h1 align="center">
<strong>GifFileDeployer</strong>
</h1>

<p align="center"> 
 
  <strong>一个用于自动化部署项目的 Bash 脚本，支持 Git 仓库同步、增量更新、备份恢复等功能。</strong>
</p>

<p align="center">
  <a href="#功能特性">功能特性</a> •
  <a href="#使用方法">使用方法</a> •
  <a href="#参数说明">参数说明</a> •
  <a href="#目录结构">目录结构</a> •
  <a href="#部署流程">部署流程</a> •
  <a href="#状态码说明">状态码说明</a> •
  <a href="#注意事项">注意事项</a>
</p>

<br>

## 功能特性

| 功能 | 说明 |
|------|------|
| 🔄 **Git 同步** | 自动从远程 Git 仓库拉取最新代码 |
| 📦 **增量部署** | 仅同步变更的文件，提高部署效率 |
| 📋 **自动备份** | 部署前自动备份将要更改的文件 |
| 🚀 **一键回滚** | 部署失败时自动恢复到上一版本 |
| 📊 **部署统计** | 显示部署过程中的文件变更统计信息 |
| 🎯 **多分支支持** | 可以部署指定的 Git 分支 |
| 🛡️ **参数验证** | 部署前验证所有参数的合法性 |
| 📈 **进度显示** | 直观的进度条显示部署进度 |
| 📝 **详细日志** | 可选的详细模式，显示部署过程中的详细信息 |

## 使用方法

### 基本用法

```bash
# 使用默认配置进行部署
./deploy.sh

# 使用详细模式进行部署（显示详细过程信息）
./deploy.sh -v

# 部署指定分支
./deploy.sh -b develop

# 指定部署工作目录和分支
./deploy.sh -w /path/to/deploy -b feature/new-ui

# 指定目标目录和分支
./deploy.sh -t /path/to/target -b feature/new-ui
```

## 参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `-h` | 显示帮助信息 | - |
| `-v` | 详细模式，显示更多部署过程信息 | 关闭 |
| `-t <target_dir>` | 设置目标部署目录 | `/www/wwwroot/test.hctx.cc` |
| `-r <git_repo>` | 设置Git仓库地址 | `git@codeup.aliyun.com:685f785033ca8867a43522e6/gysx/gysx-server-v2.git` |
| `-w <deploy_dir>` | 设置部署工作目录，基于此目录和分支名自动设置缓存、备份等路径 | 脚本所在目录下的 `deploy` 目录 |
| `-c <git_cache>` | 设置Git缓存目录 | `<分支部署目录>/cache` |
| `-b <git_branch>` | 设置Git分支 | `master` |
| `-d <backup_dir>` | 设置备份目录 | `<分支部署目录>/backups` |
| `-n <max_backups>` | 设置最大备份数量 | `5` |
| `-s <status_file>` | 设置状态文件路径 | `<分支部署目录>/deploy_status` |
| `-e <error_file>` | 设置错误详情文件路径 | `<分支部署目录>/error_details` |

## 目录结构

当指定部署工作目录时，脚本会自动创建以下目录结构：

```
<deploy_dir>/                   # 部署工作目录
└── <branch_name>/              # 分支部署目录
    ├── cache/                  # Git缓存目录
    ├── backups/                # 备份目录
    ├── deploy_status           # 状态文件
    └── error_details           # 错误详情文件
```

## 部署流程

1. **参数验证**: 验证所有输入参数的合法性
2. **初始化缓存**: 如果缓存目录不存在，则克隆远程仓库
3. **更新代码**: 从远程仓库拉取最新代码
4. **比较差异**: 比较当前版本与上次部署版本的文件差异
5. **创建备份**: 对将要更改的文件创建备份
6. **同步文件**: 将变更的文件同步到目标目录
7. **清理文件**: 删除已移除的文件
8. **更新版本**: 记录当前部署的版本号
9. **清理旧备份**: 保留指定数量的备份，删除旧备份

## 状态码说明

| 状态码 | 说明 |
|--------|------|
| 0 | 部署成功 |
| 1 | 部署失败 |
| 10 | 无变更 |

## 注意事项

1. 脚本会在部署前自动创建所需的目录结构
2. 部署过程中出现错误会自动回滚到上一版本
3. 默认保留最近5个备份，可通过 `-n` 参数调整
4. 脚本使用 `set -euo pipefail` 选项，遇到错误会立即退出
5. 部署过程中会自动处理中文文件名的编码问题